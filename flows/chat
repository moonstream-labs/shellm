#!/bin/bash
# ~/.config/aios/flows/chat

# Output system messages to file descriptor 3
system_msg() {
	echo "$@" >&3
}

# Output debug messages to file descriptor 4
debug_msg() {
	echo "$@" >&4
}

# Format LLM output using bat
format_output() {
	bat --color=always \
		--unbuffered \
		--theme="base16" \
		--tabs=4 \
		--style="numbers,grid,snip" \
		--paging=never \
		--language=markdown
}

# Interact with `llm` CLI
chat_with_llm() {
	local input="$1"
	llm chat <<<"$input" 2>/dev/null # Redirect stderr to hide system messages
}

# Prompt the user for input and return it to stdin
get_user_input() {
	local prompt="$1"
	system_msg "$prompt"
	read -r input
	echo "$input"
}

# Main chat loop for continuous interaction with the LLM
main_chat_loop() {
	while true; do
		input=$(get_user_input)
		if [[ $input == "q" ]]; then
			system_msg "bye bye..."
			break
		fi
		debug_msg "Sending to LLM: $input"
		chat_with_llm "$input" | format_output
	done
}

# Set up file descriptors for system and debug messages
exec 3>&1        # System messages to stdout by default
exec 4>/dev/null # Discard debug messages by default

# Chat loop execution
system_msg "\nðŸ¦¾  Lock In.  ðŸ¦¾\n"
main_chat_loop

# Clean up file descriptors
exec 3>&-
exec 4>&-
